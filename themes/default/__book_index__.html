<!-- sidebar: book index -->
<script>
    window.gs_status.current_chapter_uri = null;
    window.gs_status.current_chapter_version = 0;

    function gs_current_pathname() {
        let p = location.pathname;
        if (p.endsWith('/')) {
            p = p + 'index.html';
        }
        return p;
    }

    function gs_set_loading() {
        document.getElementById('gsi-content').innerHTML = `<div class="block w-5 h-5">
<svg class="animate-spin ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
</svg></div>`;
        window.scrollTo({ top: 0 });
    }

    function gs_find_parent_node(node, tagName) {
        tagName = tagName.toLowerCase();
        while (node.tagName.toLowerCase() !== tagName) {
            node = node.parentNode;
        }
        return node;
    }

    function gs_set_current_chapter_uri(uri) {
        const old_uri = window.gs_status.current_chapter_uri;
        console.log(`set chapter: ${old_uri} => ${uri}`);
        if (old_uri) {
            // dynamic load part of page:
            document.querySelector(`#gsi-index a[href="{{ site.rootPath }}${old_uri}"]`).classList.remove('gsc-active');
        }
        const a = document.querySelector(`#gsi-index a[href="{{ site.rootPath }}${uri}"]`);
        a.classList.add('gsc-active');
        // set new current uri:
        window.gs_status.current_chapter_uri = uri;
        // path from root to active item should be open:
        const root = document.querySelector(`#gsi-index`);
        // find active '<div>':
        let node = gs_find_parent_node(a, 'div');
        while (node !== root) {
            if (node.tagName.toLowerCase() === 'div') {
                let span_closed = node.querySelector(':scope > a span.gsc-index-item-closed');
                if (span_closed) {
                    gs_index_item_collapse({ target: span_closed }, 'closed', 'open');
                }
            }
            node = node.parentNode;
        }
    }

    function gs_load_chapter(uri, shouldPushState) {
        if (uri === window.gs_status.current_chapter_uri) {
            return;
        }
        gs_set_current_chapter_uri(uri);
        if (shouldPushState) {
            console.log(`push state: ${uri}`);
            history.pushState({}, '', `{{ site.rootPath }}${uri}`);
        }
        console.log(`try load new chapter: ${uri}`);
        if (window.gs_status.show_offcanvas) {
            gitsite.hideOffcanvas();
        }
        gs_set_loading();
        window.gs_status.current_chapter_version++;
        const version = window.gs_status.current_chapter_version;
        gs_load_chapter_content(uri).then((html) => {
            if (version === window.gs_status.current_chapter_version) {
                console.log(`loaded ok: ${uri}`);
                gitsite.setInnerHTML(document.querySelector('#gsi-content'), html);
                document.title = document.querySelector('#gsi-chapter-title h1').innerHTML + ' - ' + window.gs_status.title_suffix;
                gitsite.triggerContentChangedListener();
            }
        }).catch(err => {
            console.error(err);
        });
    }

    async function gs_load_chapter_content(uri) {
        // load /books/<name>/<chapter>/content.html:
        let chapter_uri = uri.substring(0, uri.length - 'index.html'.length) + 'content.html';
        let resp = await fetch(`{{ site.rootPath }}${chapter_uri}`);
        if (resp.status === 200) {
            return await resp.text();
        }
    }

    // set open/closed:
    function gs_index_item_collapse(e, fromState, toState) {
        e.stopPropagation && e.stopPropagation();
        // div.gsc-index-item > a > span.gsc-index-item-open-or-closed:click 
        let node = gs_find_parent_node(e.target, 'div');
        node.classList.remove(`gsc-index-item-${fromState}`);
        node.classList.add(`gsc-index-item-${toState}`);
        return false;
    }
</script>
<!--
{% set icon_closed = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>' %}
{% set icon_open = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>' %}
{% macro index_item(node) %}
<div class="gsc-index-item gsc-index-item-closed">
    <a class="truncate" href="{{ site.rootPath }}/books/{{ node.uri }}/index.html" onclick="gs_load_chapter('/books/{{ node.uri }}/index.html',true);return false;">
        {% if site.books and site.books.indexMarker %}
        <span class="gsc-index-item-marker">{{ node.marker }}.</span>
        {% endif %}
        <span class="gsc-index-item-title">{{ node.title }}</span>
        {% if node.children.length > 0 %}
        <span class="gsc-index-item-action gsc-index-item-closed" onclick="return gs_index_item_collapse(event, 'closed', 'open')">
            {{ icon_closed | safe }}
        </span>
        <span class="gsc-index-item-action gsc-index-item-open" onclick="return gs_index_item_collapse(event, 'open', 'closed')">
            {{ icon_open | safe }}
        </span>
        {% endif %}
    </a>
    {% if node.children.length > 0 %}
    <div class="gsc-index-item-children">
        {% for item in node.children %}
        {{ index_item(item) }}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endmacro %}
-->
<div id="gsi-index">
    <div id="gsi-sidebar-tools" class="mb-4">
        <div class="flex items-center space-x-3">
            <!-- search icon -->
            <a class="inline-block py-1 px-2 rounded" href="#0" onclick="gitsite.showSearch();return false;" title="Search">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline-block w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
            </a>
            <!-- light/dark mode toggles -->
            <a class="inline-block py-1 px-2 rounded gsc-hidden-on-dark" href="#0" onclick="gitsite.setDarkMode(true);return false;" title="Switch to dark mode">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline-block w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                </svg>
            </a>
            <a class="inline-block py-1 px-2 rounded gsc-hidden-on-light" href="#0" onclick="gitsite.setDarkMode(false);return false;" title="Switch to light mode">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline-block w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                </svg>
            </a>
            <!-- homepage link icon -->
            <a class="inline-block py-1 px-2 rounded" href="{{ site.contact.homepage }}" target="_blank" rel="noopener noreferrer" title="Homepage">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline-block w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1 1 0 011.591 0L21.75 12" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75" />
                </svg>
            </a>
            <!-- sidebar toggle (desktop collapse/expand) -->
            <a id="gsi-sidebar-toggle-inline" href="#0" aria-label="Toggle sidebar" aria-pressed="false"
                class="hidden md:inline-flex items-center justify-center py-1 px-2 rounded text-sky-600 dark:text-sky-300 bg-transparent hover:bg-transparent active:bg-transparent focus:bg-transparent focus:outline-none focus:ring-0 appearance-none">
                <span class="gsi-sidebar-toggle-icon-expanded">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline-block w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 6h15M4.5 12h15m-15 6h15" />
                    </svg>
                </span>
                <span class="gsi-sidebar-toggle-icon-collapsed hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline-block w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 6h15M4.5 12h15m-11 6h11" />
                    </svg>
                </span>
            </a>
        </div>
    </div>
    <h3>{{ book.title }}</h3>
    {% for item in book.children %}
    {{ index_item(item) }}
    {% endfor %}
</div>
<script>
    gs_set_current_chapter_uri(gs_current_pathname().substring('{{ site.rootPath }}'.length));
    window.onpopstate = function (e) {
        console.log(`pop state: ${gs_current_pathname()}`);
        gs_load_chapter(gs_current_pathname().substring('{{ site.rootPath }}'.length));
    }
</script>
<!--// sidebar: book index -->